<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref as dbRef, onValue, set as dbSet, get as dbGet } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQOtE5v_GKRpmPaNeuOgceUcLGlsjA4F8",
  authDomain: "dryicenotif.firebaseapp.com",
  databaseURL: "https://dryicenotif-default-rtdb.firebaseio.com",
  projectId: "dryicenotif",
  storageBucket: "dryicenotif.firebasestorage.app",
  messagingSenderId: "217680440618",
  appId: "1:217680440618:web:c07ecbe063e68ea49bc253",
  measurementId: "G-GEJ4RCBGF3"
};

const TELEGRAM_TOKEN = "...";
const TELEGRAM_CHAT_ID = "...";
const FIVE_MINUTES = 5 * 60 * 1000;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const btn = document.getElementById("notifyBtn");
const lastSentDisplay = document.getElementById("lastSentDisplay");

let countdownInterval = null;
let displayInterval = null;

function formatTime(ms) {
  const totalSeconds = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(totalSeconds/60);
  const s = totalSeconds%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}

function updateDisplay(remoteTimestamp) {
  if(displayInterval) clearInterval(displayInterval);
  if(!remoteTimestamp){ lastSentDisplay.textContent="No notification sent yet."; btn.disabled=false; return; }
  function tick() {
    const elapsed = Date.now() - remoteTimestamp;
    if(elapsed<5000) lastSentDisplay.textContent="Notification just sent.";
    else if(elapsed<60000) lastSentDisplay.textContent=`Last sent ${Math.floor(elapsed/1000)}s ago.`;
    else if(elapsed<3600000){ const m=Math.floor(elapsed/60000), s=Math.floor((elapsed%60000)/1000); lastSentDisplay.textContent=`Last sent ${m}m ${s}s ago.`; }
    else { const h=Math.floor(elapsed/3600000), m=Math.floor((elapsed%3600000)/60000); lastSentDisplay.textContent=`Last sent ${h}h ${m}m ago.`; }
  }
  tick();
  displayInterval = setInterval(tick, 1000);
}

function startCountdown(remoteTimestamp){
  if(countdownInterval) clearInterval(countdownInterval);
  if(!remoteTimestamp){ btn.disabled=false; btn.textContent="Send Notification"; return; }
  const remaining = FIVE_MINUTES - (Date.now() - remoteTimestamp);
  if(remaining <=0){ btn.disabled=false; btn.textContent="Send Notification"; return; }
  btn.disabled=true; btn.textContent=`Thank you! — available in ${formatTime(remaining)}`;
  countdownInterval = setInterval(()=>{
    const nowRemaining = FIVE_MINUTES - (Date.now() - remoteTimestamp);
    if(nowRemaining<=0){ clearInterval(countdownInterval); btn.disabled=false; btn.textContent="Send Notification"; }
    else btn.textContent=`Thank you! — available in ${formatTime(nowRemaining)}`;
  },1000);
}

signInAnonymously(auth).catch(err=>console.error("Anonymous sign-in failed:", err));

onAuthStateChanged(auth, user=>{
  if(user){
    const lastSentRef = dbRef(db,"dryice/lastSent");
    onValue(lastSentRef, snapshot=>{
      const val = snapshot.val();
      const ts = typeof val==="number"?val:(val?Number(val):null);
      updateDisplay(ts);
      startCountdown(ts);
    }, err=>{
      console.error("Firebase read failed:", err);
      lastSentDisplay.textContent="Database read failed (check rules/auth).";
      btn.disabled=false;
    });
  }
});

btn.addEventListener("click", async ()=>{
  btn.disabled=true; btn.textContent="Sending...";
  const now = Date.now();
  const msgText = `Dry Ice Alert - QR code scanned on ${new Date(now).toLocaleString()}`;

  try {
    const tgResp = await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msgText)}`);
    if(!tgResp.ok){ const body=await tgResp.json(); throw new Error(body.description||'Telegram error'); }

    await dbSet(dbRef(db,"dryice/lastSent"), now); // will fail if outside ±2 min
  } catch(err){
    console.error("Notification failed:", err);
    lastSentDisplay.textContent="Send failed — check server time or rules.";
    btn.disabled=false;
    btn.textContent="Send Notification";
  }
});
</script>
